<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP WASM Server - Go Implementation</title>
    <meta name="description" content="Model Context Protocol server running in WebAssembly with Go">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
        <header>
            <h1>MCP WASM Server</h1>
            <p class="subtitle">Model Context Protocol ‚Ä¢ Go ‚Ä¢ WebAssembly</p>
            <div id="status" class="status-badge loading">
                <span class="status-indicator"></span>
                <span>Loading WASM...</span>
            </div>
        </header>

        <div class="card">
            <h2>üõ†Ô∏è Server Information</h2>
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Protocol Version</div>
                    <div class="info-value" id="protocol-version">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Server Name</div>
                    <div class="info-value" id="server-name">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Server Version</div>
                    <div class="info-value" id="server-version">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Available Tools</div>
                    <div class="info-value" id="tool-count">-</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>üéØ Quick Actions</h2>
            <div class="button-group">
                <button class="btn-primary" onclick="initializeServer()" id="initBtn" disabled>
                    <span>Initialize Server</span>
                </button>
                <button class="btn-secondary" onclick="listTools()" id="listBtn" disabled>
                    <span>List Tools</span>
                </button>
                <button class="btn-primary" onclick="callGetCurrentTime()" id="callBtn" disabled>
                    <span>Call getCurrentTime Tool</span>
                </button>
            </div>

            <h3>Response Output</h3>
            <div class="output-container">
                <pre id="output">Waiting for WASM to load...</pre>
            </div>
        </div>

        <div class="card">
            <h2>üìö Available Tools</h2>
            <div id="tools-list">
                <p style="color: var(--text-muted);">Initialize the server to see available tools</p>
            </div>
        </div>
    </div>

    <script src="wasm_exec.js"></script>
    <script>
        let requestId = 1;

        function updateStatus(status, message) {
            const statusEl = document.getElementById('status');
            statusEl.className = `status-badge ${status}`;
            statusEl.innerHTML = `
                <span class="status-indicator"></span>
                <span>${message}</span>
            `;
        }

        function formatJSON(obj) {
            return JSON.stringify(obj, null, 2)
                .replace(/"([^"]+)":/g, '<span class="json-key">"$1"</span>:')
                .replace(/: "([^"]+)"/g, ': <span class="json-string">"$1"</span>')
                .replace(/: (\d+)/g, ': <span class="json-number">$1</span>')
                .replace(/: (true|false)/g, ': <span class="json-boolean">$1</span>');
        }

        function displayOutput(data) {
            const output = document.getElementById('output');
            if (typeof data === 'object') {
                output.innerHTML = formatJSON(data);
            } else {
                output.textContent = data;
            }
        }

        function sendRequest(method, params = null) {
            const request = {
                jsonrpc: "2.0",
                id: requestId++,
                method: method
            };

            if (params) {
                request.params = params;
            }

            const requestJSON = JSON.stringify(request);
            console.log('Sending request:', requestJSON);

            const responseJSON = mcpHandleRequest(requestJSON);
            console.log('Received response:', responseJSON);

            const response = JSON.parse(responseJSON);
            displayOutput(response);

            return response;
        }

        function initializeServer() {
            const response = sendRequest('initialize', {
                protocolVersion: "2024-11-05",
                clientInfo: {
                    name: "web-client",
                    version: "1.0.0"
                }
            });

            if (response.result) {
                document.getElementById('protocol-version').textContent =
                    response.result.protocolVersion;
                document.getElementById('server-name').textContent =
                    response.result.serverInfo.name;
                document.getElementById('server-version').textContent =
                    response.result.serverInfo.version;

                // Auto-list tools after initialization
                setTimeout(listTools, 500);
            }
        }

        function listTools() {
            const response = sendRequest('tools/list');

            if (response.result && response.result.tools) {
                const tools = response.result.tools;
                document.getElementById('tool-count').textContent = tools.length;

                const toolsList = document.getElementById('tools-list');
                toolsList.innerHTML = tools.map(tool => `
                    <div class="info-item" style="margin-bottom: 1rem;">
                        <div class="info-label">${tool.name}</div>
                        <div style="color: var(--text-secondary); margin-top: 0.5rem;">
                            ${tool.description}
                        </div>
                        <div class="code-block" style="margin-top: 0.5rem;">
                            ${JSON.stringify(tool.inputSchema, null, 2)}
                        </div>
                    </div>
                `).join('');
            }
        }

        function callGetCurrentTime() {
            sendRequest('tools/call', {
                name: 'getCurrentTime',
                arguments: {}
            });
        }

        // Load WASM
        const go = new Go();
        WebAssembly.instantiateStreaming(fetch("main.wasm"), go.importObject)
            .then((result) => {
                go.run(result.instance);

                // Wait for server to be ready
                const checkReady = setInterval(() => {
                    if (window.mcpServerReady) {
                        clearInterval(checkReady);
                        updateStatus('ready', 'Server Ready');

                        // Enable buttons
                        document.getElementById('initBtn').disabled = false;
                        document.getElementById('listBtn').disabled = false;
                        document.getElementById('callBtn').disabled = false;

                        displayOutput('MCP Server is ready. Click "Initialize Server" to begin.');
                    }
                }, 100);
            })
            .catch((err) => {
                console.error('Failed to load WASM:', err);
                updateStatus('error', 'Failed to load WASM');
                displayOutput('Error loading WASM: ' + err.message);
            });
    </script>
</body>

</html>